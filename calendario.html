<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Multi-agenda - Estudio Colectivo UNAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="material-study.css">
    <style>
        /* Estilos específicos para FullCalendar con Material Design 3 */
        .fc-theme-standard .fc-scrollgrid,
        .fc-theme-standard td,
        .fc-theme-standard th {
            border-color: var(--md-surface-variant);
        }
        
        .fc .fc-button-primary {
            background-color: var(--md-primary-50);
            border-color: var(--md-primary-50);
            color: var(--md-on-primary);
            font-family: 'Roboto', sans-serif;
            border-radius: var(--md-radius-small);
            box-shadow: var(--md-elevation-1);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        
        .fc .fc-button-primary:hover {
            background-color: var(--md-primary-40);
            border-color: var(--md-primary-40);
            box-shadow: var(--md-elevation-2);
        }
        
        .fc .fc-button-primary:disabled {
            background-color: rgba(0, 0, 0, 0.12);
            border-color: rgba(0, 0, 0, 0.12);
            color: rgba(0, 0, 0, 0.38);
        }
        
        .fc .fc-button-primary:not(:disabled).fc-button-active, 
        .fc .fc-button-primary:not(:disabled):active {
            background-color: var(--md-primary-60);
            border-color: var(--md-primary-60);
        }
        
        .fc-theme-standard .fc-list-day-cushion {
            background-color: var(--md-primary-95);
        }
        
        .fc-event {
            border-radius: var(--md-radius-small);
            box-shadow: var(--md-elevation-1);
            cursor: pointer;
            border-width: 0;
            transition: box-shadow 0.2s;
        }
        
        .fc-event:hover {
            box-shadow: var(--md-elevation-2);
        }
        
        .disponibilidad-comun {
            background-color: var(--md-secondary-80) !important;
            border-color: var(--md-secondary-50) !important;
            color: var(--md-on-secondary) !important;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: var(--md-spacing-small);
            border-radius: var(--md-radius-small);
            display: inline-block;
        }
        
        /* Para asegurar que el calendario ocupe todo el espacio disponible */
        .fc {
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        @media (max-width: 768px) {
            .fc {
                height: calc(100vh - 200px);
            }
        }
        
        /* Para integrar mejor el calendario con Material Design */
        .fc-header-toolbar {
            margin-bottom: var(--md-spacing-medium) !important;
            padding: var(--md-spacing-small);
        }
        
        .fc-view-harness {
            background-color: var(--md-surface);
            border-radius: var(--md-radius-medium);
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- Barra superior -->
    <header class="md-top-app-bar">
        <div class="md-top-app-bar__row">
            <section class="md-top-app-bar__section">
                <span class="md-top-app-bar__nav-icon" id="menu-toggle">
                    <span class="material-icons">menu</span>
                </span>
                <span class="md-top-app-bar__title">Calendario Multi-agenda</span>
            </section>
            <section class="md-top-app-bar__section--align-end">
                <div class="md-top-app-bar__action-item">
                    <span class="material-icons">notifications</span>
                </div>
                <div class="md-top-app-bar__action-item" id="theme-toggle">
                    <span class="material-icons">dark_mode</span>
                </div>
                <div class="md-top-app-bar__action-item">
                    <div class="md-avatar md-avatar--small">
                        <span>U</span>
                    </div>
                </div>
            </section>
        </div>
    </header>

    <!-- Navegación lateral -->
    <div class="md-drawer" id="nav-drawer">
        <div class="md-drawer__header">
            <div class="md-drawer__title">Estudio Colectivo UNAL</div>
        </div>
        <div class="md-drawer__content">
            <nav class="md-nav-list">
                <a href="dashboard.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">dashboard</span>
                    <span class="md-nav-list__text">Dashboard</span>
                </a>
                <a href="grupos.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">group</span>
                    <span class="md-nav-list__text">Grupos</span>
                </a>
                <a href="tareas.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">assignment</span>
                    <span class="md-nav-list__text">Tareas</span>
                </a>
                <a href="calendario.html" class="md-nav-list__item md-nav-list__item--active">
                    <span class="md-nav-list__icon material-icons">calendar_today</span>
                    <span class="md-nav-list__text">Calendario</span>
                </a>
                <a href="resumenes.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">summarize</span>
                    <span class="md-nav-list__text">Resúmenes</span>
                </a>
                <a href="chat.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">chat</span>
                    <span class="md-nav-list__text">Chat</span>
                </a>
                <a href="evaluaciones.html" class="md-nav-list__item">
                    <span class="md-nav-list__icon material-icons">assignment_turned_in</span>
                    <span class="md-nav-list__text">Evaluaciones</span>
                </a>
            </nav>
        </div>
    </div>
    <div class="md-drawer__overlay" id="drawer-overlay"></div>

    <!-- Contenido principal -->
    <main class="container md-mt-large">
        <!-- Controles de filtrado -->
        <div class="md-card md-mb-large">
            <h4 class="md-card__title">
                <span class="material-icons md-mr-small" style="vertical-align: middle;">filter_alt</span>
                Filtros y Opciones
            </h4>
            
            <div class="md-tabs md-mb-medium">
                <div class="md-tab md-tab--active" id="tab-personas">Participantes</div>
                <div class="md-tab" id="tab-leyenda">Leyenda de colores</div>
                <div class="md-tab" id="tab-opciones">Opciones avanzadas</div>
            </div>
            
            <div class="md-card__content">
                <!-- Contenido de la pestaña Participantes -->
                <div id="contenido-personas" class="tab-contenido" style="display: block;">
                    <div class="md-layout-grid">
                        <div class="md-layout-grid__cell md-layout-grid__cell--span-12-desktop">
                            <div class="md-flex md-justify-between md-items-center md-mb-medium">
                                <h5 class="md-title-medium">Selecciona los participantes para el calendario</h5>
                                <div>
                                    <button class="md-button md-button--text" id="seleccionar-todos">
                                        <span class="material-icons md-mr-small" style="font-size: 18px;">select_all</span>
                                        Todos
                                    </button>
                                    <button class="md-button md-button--text" id="deseleccionar-todos">
                                        <span class="material-icons md-mr-small" style="font-size: 18px;">deselect</span>
                                        Ninguno
                                    </button>
                                </div>
                            </div>
                            
                            <div class="md-layout-grid md-bg-surface-variant" style="padding: var(--md-spacing-medium); border-radius: var(--md-radius-medium);">
                                <div id="personas-checkboxes" class="md-layout-grid__cell md-layout-grid__cell--span-12-desktop md-flex md-flex-wrap md-gap-medium">
                                    <!-- Checkboxes generados dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de la pestaña Leyenda -->
                <div id="contenido-leyenda" class="tab-contenido" style="display: none;">
                    <div class="md-layout-grid">
                        <div class="md-layout-grid__cell md-layout-grid__cell--span-12-desktop">
                            <h5 class="md-title-medium md-mb-medium">Identificación de colores en el calendario</h5>
                            <div class="md-bg-surface-variant" style="padding: var(--md-spacing-medium); border-radius: var(--md-radius-medium);">
                                <div class="md-flex md-flex-wrap md-gap-medium" id="calendario-leyenda">
                                    <!-- Leyenda generada dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de la pestaña Opciones -->
                <div id="contenido-opciones" class="tab-contenido" style="display: none;">
                    <div class="md-layout-grid">
                        <div class="md-layout-grid__cell md-layout-grid__cell--span-6-desktop">
                            <h5 class="md-title-medium md-mb-medium">Configuración de visualización</h5>
                            <div class="md-bg-surface-variant" style="padding: var(--md-spacing-medium); border-radius: var(--md-radius-medium);">
                                <div class="md-mb-small md-flex md-justify-between md-items-center">
                                    <span>Mostrar fines de semana</span>
                                    <label class="md-switch">
                                        <input type="checkbox" class="md-switch__input" checked>
                                        <span class="md-switch__track"></span>
                                    </label>
                                </div>
                                <div class="md-mb-small md-flex md-justify-between md-items-center">
                                    <span>Agrupar eventos superpuestos</span>
                                    <label class="md-switch">
                                        <input type="checkbox" class="md-switch__input" checked>
                                        <span class="md-switch__track"></span>
                                    </label>
                                </div>
                                <div class="md-flex md-justify-between md-items-center">
                                    <span>Mostrar horas pasadas</span>
                                    <label class="md-switch">
                                        <input type="checkbox" class="md-switch__input">
                                        <span class="md-switch__track"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="md-layout-grid__cell md-layout-grid__cell--span-6-desktop">
                            <h5 class="md-title-medium md-mb-medium">Intervalos de tiempo</h5>
                            <div class="md-bg-surface-variant" style="padding: var(--md-spacing-medium); border-radius: var(--md-radius-medium);">
                                <div class="md-text-field md-mb-medium">
                                    <select id="hora-inicio" class="md-text-field__input">
                                        <option value="6">6:00 AM</option>
                                        <option value="7">7:00 AM</option>
                                        <option value="8" selected>8:00 AM</option>
                                        <option value="9">9:00 AM</option>
                                    </select>
                                    <label for="hora-inicio" class="md-text-field__label">Hora de inicio</label>
                                </div>
                                <div class="md-text-field">
                                    <select id="hora-fin" class="md-text-field__input">
                                        <option value="17">5:00 PM</option>
                                        <option value="18">6:00 PM</option>
                                        <option value="19">7:00 PM</option>
                                        <option value="20" selected>8:00 PM</option>
                                        <option value="21">9:00 PM</option>
                                        <option value="22">10:00 PM</option>
                                    </select>
                                    <label for="hora-fin" class="md-text-field__label">Hora de fin</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="md-card__actions">
                <button id="buscarEspaciosComunes" class="md-button md-button--filled">
                    <span class="material-icons">search</span>
                    Buscar Espacios Comunes
                </button>
                <button id="exportar-calendario" class="md-button md-button--outlined">
                    <span class="material-icons">download</span>
                    Exportar
                </button>
            </div>
        </div>

        <!-- Calendario -->
        <div class="md-card md-mb-large">
            <h4 class="md-card__title">Agenda Compartida</h4>
            <div class="md-card__content">
                <div id="calendario"></div>
            </div>
        </div>
    </main>

    <!-- Botón flotante para añadir evento rápido -->
    <div class="md-fab" id="agregar-evento-rapido">
        <span class="material-icons">add</span>
    </div>

    <!-- Diálogo para detalles del evento -->
    <div class="md-dialog-container" id="modalEventoContainer">
        <div class="md-dialog-overlay"></div>
        <div class="md-dialog">
            <div class="md-dialog__header">
                <h3 class="md-dialog__title">Detalles del Evento</h3>
            </div>
            <div class="md-dialog__content">
                <p><strong>Título:</strong> <span id="modalTitulo"></span></p>
                <p><strong>Persona:</strong> <span id="modalPersona"></span></p>
                <p><strong>Fecha:</strong> <span id="modalFecha"></span></p>
                <p><strong>Descripción:</strong> <span id="modalDescripcion"></span></p>
            </div>
            <div class="md-dialog__actions">
                <button class="md-button md-button--text" id="cerrarModalEvento">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Diálogo para agendar nueva cita -->
    <div class="md-dialog-container" id="modalNuevaCitaContainer">
        <div class="md-dialog-overlay"></div>
        <div class="md-dialog">
            <div class="md-dialog__header">
                <h3 class="md-dialog__title">Agendar Nueva Cita</h3>
            </div>
            <div class="md-dialog__content">
                <form id="formNuevaCita">
                    <div class="md-text-field md-mb-medium">
                        <input type="text" id="tituloCita" class="md-text-field__input" placeholder=" " required>
                        <label for="tituloCita" class="md-text-field__label">Título de la cita</label>
                    </div>
                    <div class="md-text-field md-mb-medium">
                        <textarea id="descripcionCita" class="md-text-field__input" rows="3" placeholder=" "></textarea>
                        <label for="descripcionCita" class="md-text-field__label">Descripción</label>
                    </div>
                    <h5 class="md-title-medium md-mb-small">Participantes</h5>
                    <div id="participantesCita" class="md-mb-medium">
                        <!-- Lista de participantes generada dinámicamente -->
                    </div>
                    <h5 class="md-title-medium md-mb-small">Horario</h5>
                    <p id="horarioCita" class="md-body-medium md-color-primary"></p>
                </form>
            </div>
            <div class="md-dialog__actions">
                <button class="md-button md-button--text" id="cerrarModalNuevaCita">Cancelar</button>
                <button class="md-button md-button--filled" id="guardarCita">Guardar Cita</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // UI Elements para Material Design
            const menuToggle = document.getElementById('menu-toggle');
            const navDrawer = document.getElementById('nav-drawer');
            const drawerOverlay = document.getElementById('drawer-overlay');
            const themeToggle = document.getElementById('theme-toggle');
            const addEventBtn = document.getElementById('agregar-evento-rapido');
            
            const modalEventoContainer = document.getElementById('modalEventoContainer');
            const cerrarModalEvento = document.getElementById('cerrarModalEvento');
            
            const modalNuevaCitaContainer = document.getElementById('modalNuevaCitaContainer');
            const cerrarModalNuevaCita = document.getElementById('cerrarModalNuevaCita');
            const guardarCita = document.getElementById('guardarCita');
            
            // Toggle del menú lateral
            menuToggle.addEventListener('click', function() {
                navDrawer.classList.toggle('md-drawer--open');
                drawerOverlay.classList.toggle('md-drawer__overlay--open');
            });

            drawerOverlay.addEventListener('click', function() {
                navDrawer.classList.remove('md-drawer--open');
                drawerOverlay.classList.remove('md-drawer__overlay--open');
            });

            // Toggle del tema oscuro/claro
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-theme');
                const icon = themeToggle.querySelector('.material-icons');
                if (document.body.classList.contains('dark-theme')) {
                    icon.textContent = 'light_mode';
                } else {
                    icon.textContent = 'dark_mode';
                }
            });
            
            // Manejar modales Material Design
            cerrarModalEvento.addEventListener('click', function() {
                modalEventoContainer.classList.remove('md-dialog-container--open');
            });
            
            cerrarModalNuevaCita.addEventListener('click', function() {
                modalNuevaCitaContainer.classList.remove('md-dialog-container--open');
            });
            
            // Botón flotante para añadir evento rápido
            addEventBtn.addEventListener('click', function() {
                // Aquí podrías implementar la lógica para añadir un evento rápido
                // Por ahora mostraremos un snackbar
                mostrarSnackbar('Función de añadir evento rápido en desarrollo');
            });
            
            // Función para mostrar snackbar
            function mostrarSnackbar(mensaje, esError = false) {
                // Eliminar snackbar existente si hay
                const snackbarExistente = document.querySelector('.md-snackbar');
                if (snackbarExistente) {
                    snackbarExistente.remove();
                }
                
                const snackbar = document.createElement('div');
                snackbar.classList.add('md-snackbar');
                snackbar.innerHTML = `
                    <div class="md-snackbar__text">${mensaje}</div>
                    <button class="md-snackbar__action">Cerrar</button>
                `;
                
                if (esError) {
                    snackbar.style.backgroundColor = 'var(--md-error)';
                }
                
                document.body.appendChild(snackbar);
                
                // Mostrar el snackbar
                setTimeout(() => {
                    snackbar.classList.add('md-snackbar--visible');
                }, 10);
                
                // Ocultar después de 4 segundos
                setTimeout(() => {
                    snackbar.classList.remove('md-snackbar--visible');
                    setTimeout(() => {
                        snackbar.remove();
                    }, 300);
                }, 4000);
                
                // Botón de cerrar
                snackbar.querySelector('.md-snackbar__action').addEventListener('click', function() {
                    snackbar.classList.remove('md-snackbar--visible');
                    setTimeout(() => {
                        snackbar.remove();
                    }, 300);
                });
            }

            // Datos de ejemplo
            const personas = [
                { id: 1, nombre: 'Ana García', color: '#FF6B6B' },
                { id: 2, nombre: 'Carlos López', color: '#4ECDC4' },
                { id: 3, nombre: 'María Rodríguez', color: '#95A5A6' },
                { id: 4, nombre: 'Juan Martínez', color: '#F7D794' }
            ];

            // Generar eventos aleatorios para cada persona
            const eventos = generarEventosAleatorios(personas);

            // Generar checkboxes para filtrar por persona
            const checkboxesContainer = document.getElementById('personas-checkboxes');
            personas.forEach(persona => {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'md-card md-mb-small';
                checkboxContainer.style.minWidth = '180px';
                checkboxContainer.style.padding = 'var(--md-spacing-small) var(--md-spacing-medium)';
                checkboxContainer.style.display = 'flex';
                checkboxContainer.style.alignItems = 'center';
                checkboxContainer.style.justifyContent = 'space-between';
                checkboxContainer.style.borderLeft = `4px solid ${persona.color}`;
                
                checkboxContainer.innerHTML = `
                    <div class="md-flex md-items-center">
                        <span class="color-box" style="background-color: ${persona.color}"></span>
                        <span class="md-font-medium">${persona.nombre}</span>
                    </div>
                    <label class="md-checkbox">
                        <input type="checkbox" class="md-checkbox__input persona-checkbox" value="${persona.id}" checked>
                        <span class="md-checkbox__box"></span>
                    </label>
                `;
                
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Generar leyenda
            const leyendaContainer = document.getElementById('calendario-leyenda');
            personas.forEach(persona => {
                const div = document.createElement('div');
                div.className = 'md-card md-mb-medium md-mr-medium';
                div.style.width = 'calc(50% - var(--md-spacing-medium))';
                div.style.maxWidth = '250px';
                div.style.padding = 'var(--md-spacing-small) var(--md-spacing-medium)';
                div.style.borderLeft = `4px solid ${persona.color}`;
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <span class="color-box" style="background-color: ${persona.color}"></span>
                    <span class="md-font-medium">${persona.nombre}</span>
                `;
                leyendaContainer.appendChild(div);
            });
            
            // Añadir leyenda para espacios disponibles
            const disponibleLegend = document.createElement('div');
            disponibleLegend.className = 'md-card md-mb-medium md-mr-medium';
            disponibleLegend.style.width = 'calc(50% - var(--md-spacing-medium))';
            disponibleLegend.style.maxWidth = '250px';
            disponibleLegend.style.padding = 'var(--md-spacing-small) var(--md-spacing-medium)';
            disponibleLegend.style.borderLeft = '4px solid var(--md-secondary-50)';
            disponibleLegend.style.display = 'flex';
            disponibleLegend.style.alignItems = 'center';
            disponibleLegend.innerHTML = `
                <span class="color-box disponibilidad-comun"></span>
                <span class="md-font-medium">Espacios Disponibles</span>
            `;
            leyendaContainer.appendChild(disponibleLegend);
            
            // Manejar cambio de pestañas
            document.querySelectorAll('.md-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover la clase activa de todas las pestañas
                    document.querySelectorAll('.md-tab').forEach(t => {
                        t.classList.remove('md-tab--active');
                    });
                    
                    // Añadir la clase activa a la pestaña actual
                    this.classList.add('md-tab--active');
                    
                    // Ocultar todos los contenidos
                    document.querySelectorAll('.tab-contenido').forEach(c => {
                        c.style.display = 'none';
                    });
                    
                    // Mostrar el contenido correspondiente
                    const tabId = this.id;
                    const contenidoId = tabId.replace('tab-', 'contenido-');
                    document.getElementById(contenidoId).style.display = 'block';
                });
            });
            
            // Funcionalidad para seleccionar o deseleccionar todos
            document.getElementById('seleccionar-todos').addEventListener('click', function() {
                document.querySelectorAll('.persona-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                actualizarEventosVisibles();
            });
            
            document.getElementById('deseleccionar-todos').addEventListener('click', function() {
                document.querySelectorAll('.persona-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                actualizarEventosVisibles();
            });
            
            // Funcionalidad para el botón de exportar
            document.getElementById('exportar-calendario').addEventListener('click', function() {
                mostrarSnackbar('Función de exportación en desarrollo');
            });

            // Configurar calendario
            const calendarioEl = document.getElementById('calendario');
            const calendario = new FullCalendar.Calendar(calendarioEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                events: eventos,
                eventClick: mostrarDetallesEvento,
                eventContent: function(arg) {
                    return {
                        html: `<div class="fc-event-main-frame">
                                <div class="fc-event-title-container">
                                    <div class="fc-event-title">${arg.event.title}</div>
                                    <div class="fc-event-time">${arg.timeText}</div>
                                </div>
                            </div>`
                    };
                }
            });

            calendario.render();

            // Manejar filtrado de eventos
            document.querySelectorAll('.persona-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    actualizarEventosVisibles();
                });
            });

            // Buscar espacios comunes
            document.getElementById('buscarEspaciosComunes').addEventListener('click', function() {
                const personasSeleccionadas = Array.from(document.querySelectorAll('.persona-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
                
                if (personasSeleccionadas.length < 2) {
                    mostrarSnackbar('Selecciona al menos 2 personas para buscar espacios comunes', true);
                    return;
                }

                const espaciosComunes = encontrarEspaciosComunes(eventos, personasSeleccionadas);
                
                if (espaciosComunes.length === 0) {
                    mostrarSnackbar('No se encontraron espacios comunes para las personas seleccionadas', true);
                    return;
                }
                
                mostrarEspaciosComunes(espaciosComunes, calendario);
                mostrarSnackbar(`Se encontraron ${espaciosComunes.length} espacios disponibles`);
            });

            function actualizarEventosVisibles() {
                const personasSeleccionadas = Array.from(document.querySelectorAll('.persona-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                calendario.getEvents().forEach(evento => {
                    if (evento.extendedProps.tipo === 'espacio-comun') {
                        return; // No filtrar espacios comunes
                    }
                    
                    if (personasSeleccionadas.includes(evento.extendedProps.personaId)) {
                        evento.setProp('display', 'auto');
                    } else {
                        evento.setProp('display', 'none');
                    }
                });
            }

            function mostrarDetallesEvento(info) {
                const evento = info.event;
                
                if (evento.extendedProps.tipo === 'espacio-comun') {
                    abrirModalNuevaCita(info);
                    return;
                }
                
                const persona = personas.find(p => p.id === evento.extendedProps.personaId);

                document.getElementById('modalTitulo').textContent = evento.title;
                document.getElementById('modalPersona').textContent = persona.nombre;
                document.getElementById('modalFecha').textContent = evento.start.toLocaleString();
                document.getElementById('modalDescripcion').textContent = evento.extendedProps.descripcion || 'Sin descripción';

                modalEventoContainer.classList.add('md-dialog-container--open');
            }

            function generarEventosAleatorios(personas) {
                const eventos = [];
                const fechaInicio = new Date('2025-02-17');
                const diasSimulacion = 14;

                personas.forEach(persona => {
                    for (let i = 0; i < diasSimulacion; i++) {
                        const numEventos = Math.floor(Math.random() * 3) + 1; // 1-3 eventos por día
                        
                        for (let j = 0; j < numEventos; j++) {
                            const fecha = new Date(fechaInicio);
                            fecha.setDate(fecha.getDate() + i);
                            
                            const horaInicio = 8 + Math.floor(Math.random() * 8); // Entre 8 y 15
                            fecha.setHours(horaInicio, 0, 0);
                            
                            const duracion = Math.floor(Math.random() * 3) + 1; // 1-3 horas
                            const fechaFin = new Date(fecha);
                            fechaFin.setHours(fecha.getHours() + duracion);

                            eventos.push({
                                title: `Reunión - ${persona.nombre}`,
                                start: fecha,
                                end: fechaFin,
                                backgroundColor: persona.color,
                                borderColor: persona.color,
                                extendedProps: {
                                    personaId: persona.id,
                                    descripcion: `Reunión ${j + 1} del día para ${persona.nombre}`
                                }
                            });
                        }
                    }
                });

                return eventos;
            }

            function encontrarEspaciosComunes(eventos, personasSeleccionadas) {
                const espaciosComunes = [];
                const fechaInicio = new Date('2025-02-17');
                const fechaFin = new Date('2025-03-03');
                
                for (let fecha = new Date(fechaInicio); fecha <= fechaFin; fecha.setDate(fecha.getDate() + 1)) {
                    for (let hora = 8; hora < 17; hora++) { // 8:00 - 17:00
                        const horaInicio = new Date(fecha);
                        horaInicio.setHours(hora, 0, 0);
                        const horaFin = new Date(fecha);
                        horaFin.setHours(hora + 1, 0, 0);

                        const hayConflicto = personasSeleccionadas.some(personaId => {
                            return eventos.some(evento => {
                                if (evento.extendedProps.personaId !== personaId) return false;
                                return (evento.start < horaFin && evento.end > horaInicio);
                            });
                        });

                        if (!hayConflicto) {
                            espaciosComunes.push({
                                start: horaInicio,
                                end: horaFin
                            });
                        }
                    }
                }

                return espaciosComunes;
            }

            function mostrarEspaciosComunes(espacios, calendario) {
                // Eliminar espacios comunes anteriores
                calendario.getEvents().forEach(evento => {
                    if (evento.extendedProps.tipo === 'espacio-comun') {
                        evento.remove();
                    }
                });

                // Agregar nuevos espacios comunes
                espacios.forEach(espacio => {
                    calendario.addEvent({
                        title: 'Espacio Disponible',
                        start: espacio.start,
                        end: espacio.end,
                        className: 'disponibilidad-comun',
                        extendedProps: {
                            tipo: 'espacio-comun',
                            descripcion: 'Horario disponible para todos los participantes seleccionados'
                        }
                    });
                });
            }

            function abrirModalNuevaCita(info) {
                const evento = info.event;
                const personasSeleccionadas = Array.from(document.querySelectorAll('.persona-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
                
                // Actualizar el horario en el modal
                const horarioTexto = `${evento.start.toLocaleTimeString()} - ${evento.end.toLocaleTimeString()}`;
                document.getElementById('horarioCita').textContent = `${evento.start.toLocaleDateString()} ${horarioTexto}`;

                // Generar lista de participantes
                const participantesContainer = document.getElementById('participantesCita');
                participantesContainer.innerHTML = '';
                
                personas.forEach(persona => {
                    if (personasSeleccionadas.includes(persona.id)) {
                        const div = document.createElement('div');
                        div.className = 'md-list__item';
                        div.innerHTML = `
                            <div class="md-list__text">
                                <div class="md-list__primary-text">
                                    <span class="color-box" style="background-color: ${persona.color}"></span>
                                    ${persona.nombre}
                                </div>
                            </div>
                            <div class="md-list__meta">
                                <label class="md-checkbox">
                                    <input type="checkbox" class="md-checkbox__input" checked disabled>
                                    <span class="md-checkbox__box"></span>
                                </label>
                            </div>
                        `;
                        participantesContainer.appendChild(div);
                    }
                });

                // Configurar el botón de guardar
                guardarCita.onclick = function() {
                    const titulo = document.getElementById('tituloCita').value;
                    const descripcion = document.getElementById('descripcionCita').value;
                    
                    if (!titulo) {
                        mostrarSnackbar('Por favor, ingrese un título para la cita', true);
                        return;
                    }

                    // Crear eventos para cada participante
                    personasSeleccionadas.forEach(personaId => {
                        const persona = personas.find(p => p.id === personaId);
                        calendario.addEvent({
                            title: titulo,
                            start: evento.start,
                            end: evento.end,
                            backgroundColor: persona.color,
                            borderColor: persona.color,
                            extendedProps: {
                                personaId: persona.id,
                                descripcion: descripcion,
                                participantes: personasSeleccionadas
                            }
                        });
                    });

                    // Cerrar el modal y limpiar el formulario
                    document.getElementById('formNuevaCita').reset();
                    modalNuevaCitaContainer.classList.remove('md-dialog-container--open');
                    
                    // Eliminar el espacio disponible
                    evento.remove();
                    
                    // Mostrar confirmación
                    mostrarSnackbar('Cita agendada correctamente');
                };

                // Mostrar el modal
                modalNuevaCitaContainer.classList.add('md-dialog-container--open');
            }
        });
    </script>
</body>
</html>